<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin – Review Submissions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../styles/main.css">
  <script src="../js/env.js"></script>
</head>
<body>
  <main class="container">
    <h1>📋 Pending Submissions</h1>
    <table id="submissions-table" border="1" cellpadding="8" style="width:100%;margin-top:1rem;">
      <thead>
        <tr>
          <th>Creator</th>
          <th>Type</th>
          <th>Title</th>
          <th>Link</th>
          <th>Description</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const tableBody = document.querySelector('#submissions-table tbody');

    // 👇 هذه الحماية مستقبلًا عندما تفعل Supabase Auth (غير مفعلة الآن)
    /*
    const { data: { user } } = await supabase.auth.getUser();
    if (!user || user.email !== "admin@ramallah.ai") {
      alert("Access denied!");
      window.location.href = "/";
    }
    */

    async function fetchPending() {
      const { data, error } = await supabase
        .from('submissions')
        .select('*')
        .eq('status', 'pending');

      if (error) {
        alert('❌ Failed to load submissions');
        return;
      }

      tableBody.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement('tr');

        const tdCreator = document.createElement('td');
        tdCreator.textContent = row.creator_name || '-';
        tr.appendChild(tdCreator);

        const tdType = document.createElement('td');
        tdType.textContent = row.type;
        tr.appendChild(tdType);

        const tdTitle = document.createElement('td');
        tdTitle.textContent = row.title_en || row.title_ar || '-';
        tr.appendChild(tdTitle);

        const tdLink = document.createElement('td');
        const link = document.createElement('a');
        link.href = row.link;
        link.target = '_blank';
        link.textContent = '🔗 View';
        tdLink.appendChild(link);
        tr.appendChild(tdLink);

        const tdDesc = document.createElement('td');
        tdDesc.textContent = row.desc_en || row.desc_ar || '-';
        tr.appendChild(tdDesc);

        const tdAction = document.createElement('td');
        const btn = document.createElement('button');
        btn.dataset.id = row.id;
        btn.textContent = 'Approve ✅';
        tdAction.appendChild(btn);
        tr.appendChild(tdAction);

        tableBody.appendChild(tr);
      });
    }

    tableBody.addEventListener('click', async (e) => {
      if (e.target.tagName === 'BUTTON') {
        const id = e.target.dataset.id;
        const { error } = await supabase
          .from('submissions')
          .update({ status: 'approved' })
          .eq('id', id);

        if (error) {
          alert('❌ Failed to approve');
        } else {
          e.target.closest('tr').remove();
        }
      }
    });

    fetchPending();
  </script>
</body>
</html>
